# Convert unaligned bam to fastq
`parallel -j5 "samtools fastq SRR101404{}.bam > SRR101404{}.fastq" ::: 34 35 46 49 63`
# where number refers to the end of the bam file of interest 

# Align fastq and store as sam
bwa mem -t 16 hg38.fa.gz SRR10140446.fastq > SRR10140446.sam
# need to use an indexed reference 

# Sort sam file 
samtools sort -b SRR10140446.sam -o SRR10140446_aligned_sorted.bam

# Index
samtools index -@16 SRR10140446_aligned_sorted.bam 
# multithreading helps 

# Extract chr of interest
samtools view -h SRR10140446_aligned_sorted.bam "chr10" > SRR10140446_aligned_sorted_chr10.sam
# files are large so zooming in is helpful 

# Collate
samtools collate -o SRR10140446_aligned_sorted_chr10_namecollated.bam SRR10140446_aligned_sorted_chr10.sam

# Fixmate
samtools fixmate -m SRR10140446_aligned_sorted_chr10_namecollated.bam SRR10140446_aligned_sorted_chr10_fixemate.bam

# Sort by name
samtools sort -@16 -o SRR10140446_aligned_sorted_chr10_fixmate_sorted.bam SRR10140446_aligned_sorted_chr10_fixemate.bam

# Remove duplicates
samtools markdup -r -@16 SRR10140446_aligned_sorted_chr10_fixmate_sorted.bam SRR10140446_aligned_sorted_chr10_dedup.bam
# if you don't want to remove the duplicates (but just want them flagged), do not include the -r flag 

# Get depth across chromosome file 
samtools depth SRR10140446_aligned_sorted_chr10_dedup.bam > chr10_depth.txt

# Get coverage at SNP of interest
grep 48740172 chr10_depth.txt
# substitute number for genomic position 

# Get coverage across the full chromosome
awk '{ total += $3 } END { print total/NR }' 49_chr10_depth.txt

# Get coverage across the chromosome, excluding the peak
awk '{if ($2 < 78301703 || $2 > 78499310) {total+=$3; nrow++;} } END { print total/nrow }' 49_chr10_depth.txt

# Get coverage only at the peak 
awk '{if ($2 > 78301703 && $2 < 78499310) {total+=$3; nrow++;} } END { print total/nrow }' 49_chr10_depth.txt
